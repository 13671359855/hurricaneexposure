---
title: "Using the `hurricaneexposure` package"
author: "Brooke Anderson"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r echo = FALSE, message = FALSE}
hasData <- requireNamespace("hurricaneexposuredata", quietly=TRUE)
if (!hasData) {
    knitr::opts_chunk$set(eval = FALSE)
    print(paste("Note: Examples in this vignette require that the `hurricaneexposuredata` package",
                "be installed. The system currently running this vignette does not have that package",
                "installed, so code examples will not be evaluated."))
}
```

```{r echo = FALSE, message = FALSE, warning = FALSE}
# If you need to, install the `hurricaneexposuredata` package from the drat repo:
# library(drat)
# addRepo("geanders")
# install.packages("hurricaneexposuredata")
library(hurricaneexposuredata)
library(hurricaneexposure)
```

## Package overview

This package allows you to explore and map data on county-level exposures to Atlantic-basin tropical storms between 1988 and 2015 for a number of storm hazards (e.g., wind, rain, flood events, distance from the storm track) for counties in the eastern half of the United States. This package allows the user to map exposures by county for a selected storm or to identify all storms to which selected counties were exposed, based on user-specified thresholds (for example, the package allows the user to identify all storms that brought wind of 34 knots or higher to Miami-Dade County in Florida).

If you use this package and the data in the associated data package (`hurricaneexposuredata`) for research, please cite both packages. In particular, be sure to include the version of the packages that you used, as this will make your research project more reproducible, and the data will likely be updated as we get further years of data and find improved ways to measure tropical storm exposure. The two packages can be cited as: 

- Anderson B, Yan M, Ferreri J, Crosson W, Al-Hamdan M, Schumacher A and
 Eddelbuettel D (2017). _hurricaneexposure: Explore and Map County-Level
 Hurricane Exposure in the United States_. R package version 0.0.1, <URL:
 http://CRAN.R-project.org/package=hurricaneexposure>.

- Anderson B, Schumacher A, Crosson W, Al-Hamdan M, Yan M, Ferreri J, Chen Z,
 Quiring S and Guikema S (2017). _hurricaneexposuredata: Data Characterizing
 Exposure to Hurricanes in United States Counties_. R package version 0.0.1,
 <URL: https://github.com/geanders/hurricaneexposuredata>.
  
To generate BibTex entries for the packages, you can use the `citation` function in R.

## Required set-up to use this package

This package depends on data in a data package (`hurricaneexposuredata`) that is available through a `drat` repository on GitHub. To use the `hurricaneexposure` package, you will need to install `hurricaneexposuredata` on your computer. You can do that by adding the `drat` repository to your repositories; once you do this, you can install the `hurricaneexposuredata` using the `install.packages` function (and later update it using the `update.packages` function):

```{r eval = FALSE}
library(drat)
addRepo("geanders")
install.packages("hurricaneexposuredata")
```

The `hurricaneexposuredata` data package includes data that characterizes county-level exposure to tropical storms in counties in the eastern half of the United States between 1988 and 2015 (for some hazards, exposure data is only included for a subset of these years). Tropical storms that did not pass within at least 250 km of at least one US county were excluded from these datasets. The following datasets are included with the `hurricaneexposuredata` data package: 

- `county_centers`: Location of United States county centers of population
- `hurr_tracks`: Storm tracks for Atlantic-basin storms, 1988-2015
- `closest_dist`: Closest distances between counties and a storm track, for Atlantic-basin storms, 1988-2015
- `rain`: Rainfall for US counties during Atlantic basin tropical storms, 1988-2011; daily rainfall is given from five days before to three days after the storm's closest approach to the county
- `storm_winds`: Modeled county wind speeds for Atlantic-basin storms, 1988-2015
- `storm_events`: Listings from the NOAA Storm Events database that occurred near in time and location to tropical storms, 1988-2015. This database changed the types of events it reported in 1996, which should be considered when using the data. 
- `ext_tracks_wind`: Estimated county wind speeds for Atlantic-basin storms, 1988-2015, based on the wind radii listed in the Extended Best Tracks dataset

Once you've installed and loaded `hurricaneexposuredata`, you can load the included data using the `data` function. For example:

```{r}
library(hurricaneexposuredata)
data("hurr_tracks")
head(hurr_tracks)
```

For each dataset included in `hurricaneexposuredata`, you can see the helpfiles for the data for more information about the data included in each (e.g., `?rain` to read documentation on the rain exposure data). 

## Creating time series datasets of exposure

The `hurricaneexposure` package has functions to interact with the data in the `hurricaneexposuredata` package. There are several functions in the `hurricaneexposure` package that help to take the data on county-level hazards and storm tracks and use them to create listings of exposures to tropical storms that can be easily integrated into time series datasets of, for example, health data. 

First, the `county_rain` function takes a list of county FIPS codes, bounds on the starting and ending years of the analysis, and thresholds for distance (storm path must come that close or closer to the county) and rainfall (total rainfall summed over the days you specify-- for example, `days_included = c(-1, 0, 1)` would use the total rainfall summed over the day before, day of, and day after the date when the storm was closest to the county). The function outputs a dataframe with all of the storms to which each of the counties was exposed.

For example, to get a dataset of all the storms to which Orleans Parish (FIPS 22071), and Newport News, Virginia (FIPS 51700), were exposed between 1995 and 2005, where "exposed" means that the storm passed within 100 kilometers of the county center and the rainfall over three days was 100 millimeters or more, you could run:

```{r}
county_rain(counties = c("22071", "51700"),
            start_year = 1995, end_year = 2005,
            rain_limit = 100, dist_limit = 100,
            days_included = c(-1, 0, 1))
```

In addition to giving you the names and closest dates of each storm for each county (`closest_date`-- note, this is given using the UTC timezone), this function also gives you the distance between the county and the storm's track at the time when the storm was closest to the county's population weighted center (`storm_dist`, in kilometers) and the total precipitation over the included days (`tot_precip`).

Similar functions are available in the package to create listings of county exposures to storms based on wind, distance to the storm track, and events listings from the NOAA Storm Events Database (flood and tornado events). 

To get a dataframe listing the relevant storms for multi-county communities, you can use the `multi_county_rain` function in a similar way:

```{r warning = FALSE}
communities <- data.frame(commun = c(rep("ny", 6), "no", "new"),
                         fips = c("36005", "36047", "36061",
                                  "36085", "36081", "36119",
                                  "22071", "51700"))
rain_storm_df <- multi_county_rain(communities = communities,
                                   start_year = 1995, end_year = 2005,
                                   rain_limit = 100, dist_limit = 100,
                                   days_included = c(-1, 0, 1))
```

This output includes columns for the average closest distance for any of the counties in the community (`mean_dist`), the average precipitation for all the counties (`mean_precip`), the highest precipitation for any of the counties (`max_rain`), and the smallest distance between the storm track and any of the county population-weighted centers (`min_dist`).

## Creating and writing time series of exposure

To create time series of hurricane exposure for all of the storms that meet the exposure definition for study communities, you can use the function `rain_exposure`. If you have counties for your study, you can run this with a vector of the county FIPS as the `locations` argument (specify the directory path to write the files with `out_dir`):

```{r eval = FALSE}
rain_exposure(locations = c("22071", "51700"),
              start_year = 1995, end_year = 2005,
              rain_limit = 100, dist_limit = 100,
              out_dir = "~/tmp/storms")
```

If you have multi-county communities, set `locations` instead to be a dataframe with community names (`commun` column) and FIPS codes (`fips` column):

```{r message = FALSE, warning = FALSE, eval = FALSE}
communities <- data.frame(commun = c(rep("ny", 6), "no", "new"),
                          fips = c("36005", "36047", "36061",
                          "36085", "36081", "36119",
                          "22071", "51700"))
rain_exposure(locations = communities,
              start_year = 1995, end_year = 2005,
              rain_limit = 100, dist_limit = 100, out_dir = "~/tmp/storms")
```

Both functions will output one file of exposure per county or community into the directory that you specify using the `out_dir` argument.

## Mapping hurricane exposure

This package allows you to create some different maps of hurricane exposures based on distance to the storm track and rainfall. 

### Plotting county-level exposure 

The `map_counties` function creates county choropleths of different storm exposure variables (right now, rainfall and distance from the storm tracks). For example, to plot rain exposure for Hurricane Floyd in 1999 (the ID for this storm is "Floyd-2012"):

```{r fig.width = 7, fig.height = 4, message = FALSE}
map_1 <- map_counties(storm = "Floyd-1999", metric = "rainfall")
map_1
```

You can also use this function to plot the closest distance between the storm and each county. For this, you use the argument `metric = "distance"`.

```{r fig.width = 7, fig.height = 4}
map_2 <- map_counties(storm = "Sandy-2012", metric = "distance")
map_2
```

You can map a binary variable of distance-based exposure using `map_distance_exposure`: 

```{r fig.width = 7, fig.height = 4}
allison_map <- map_distance_exposure(storm = "Allison-2001",
                                     dist_limit = 75)
plot(allison_map)
```

You can also map a binary variable of rain exposure for the communities that were exposed, based on a certain rainfall limit and distance limit:

```{r fig.width = 7, fig.height = 4}
map_3 <- map_rain_exposure(storm = "Floyd-1999", rain_limit = 125,
                           dist_limit = 500, 
                           days_included = c(-1, 0, 1))
plot(map_3)
```

### Plotting storm tracks 

The `map_tracks` function will map the hurricane tracks for one or more storms. For example, to plot the tracks of Hurricane Floyd in 1999 (the ID for this storm is "Floyd-2012"):

```{r fig.width = 5.5, fig.height = 4}
map_4 <- map_tracks(storms = "Floyd-1999")
map_4
```

There are some different options you can use for the tracks' appearance. For example, if you wanted to plot the tracks of several storms, not plot each point when the track locations were measured (typically every six hours), and use some transparency so you can see all the lines, you can use: 

```{r fig.width = 5.5, fig.height = 4}
map_5 <- map_tracks(storms = c("Floyd-1999", "Sandy-2012",
                               "Katrina-2005"),
                    plot_points = FALSE,
                    alpha = 0.5)
map_5
```

You can also add these tracks to an existing `ggplot`-created US map. You do this through the `plot_object` argument. For example, to add the storm track to the plot of distance exposure for Sandy or rain exposure for Floyd, you could run:

```{r fig.width = 7, fig.height = 4}
map_6 <- map_tracks(storms = "Sandy-2012", plot_object = map_2,
                    plot_points = FALSE)
map_6
```

```{r fig.width = 7, fig.height = 4}
map_7 <- map_tracks(storms = "Floyd-1999", plot_object = map_3,
                    plot_points = FALSE)
map_7
```


